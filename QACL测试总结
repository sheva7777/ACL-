华为三康技术有限公司
Huawei-3Com Technologies Co., Ltd.
	文档编号 Document ID	密级 Confidentiality level
		内部公开
	文档状态 Document Status	共20页 Total 20 pages
	Draft 1.00	

QACL测试总结




拟制
Prepared by 	李莲花	Date
日期	2004-09-21
评审人
Reviewed by 		Date
日期	
批准
Approved by		Date
日期	





 

华为三康技术有限公司
Huawei-3Com Technologies Co., Ltd.
版权所有  侵权必究
All rights reserved
 

修订记录 Revision Record 
日期
Date	修订
版本
Revision Version	修改
章节
Sec No. 	修改描述
Change Description	作者
Author
2004-09-21	1.00		initial 初稿完成	李莲花
				
				
				
				


















								目 录
1	QACL概述	5
2	QACL特性	5
2.1	3552 QACL特性	5
2.2	3526C QACL特性	8
2.3	3050 QACL特性	10
2.4	2050 QACL特性	12
3	问题说明	14
3.1	3552 QACL问题	14
3.2	3526C QACL问题	18
3.3	3050 QACL问题	18
3.4	2050 QACL问题	19
3.5	问题总结	19
参考资料	20









QACL测试总结
关键词：ACL QOS 
摘    要：本文主要讲述QACL特性，分别阐述不同产品的QACL的特点以及各个产品所产生的QACL问题。
对    象：希望对lanswitch平台QACL特性有所了解
缩略语清单：
ACL(Access Control List): 访问控制列表，用于对IP报文进行流分类
QOS(Quality of Service): 服务质量，指报文传送的吞吐量、时延、时延抖动、丢失率等性能
















1	 QACL概述
ACL是指通过一定的访问控制规则来实现防火墙的功能，过滤不需要的数据包和实现安全政策，实现不同网段和主机之间的访问控制，保护敏感的设备，禁止未经许可的访问；增加安全特性的同时也通过一些扩展的控制规则来对网络进行更加有效的管理，比如流量统计，流量监控，报文重定向等等特性。
QOS是指IP的服务质量，是指IP数据流通过网络时的性能。它的目的就是向用户的业务提供端到端的服务质量保证。它有一套度量指标，包括业务可用性、延迟、可变延迟、吞吐量和丢保率。QOS在可预测、可测量性方面比传统IP有了很大提高，基本解决了商业用户的需求，因而势比可以吸引更多的商业用户，形成一个新的利润增长点，带来可增值的业务种类。另外，QOS还带来了更高效的带宽使用率等，因此可以说QOS将是今后一段时间促进IP网络增长的关键技术。

2   QACL特性
ACL特性，包括流分类，流动作等，QoS特性，包括报文分类、拥塞管理和拥塞避免、流量监管和流量整形以及物理接口总速率限制等。VRP丰富的QoS特性保证了华为路由器等网络产品的QoS能力，利用华为数通设备组建的网络能够完全支持端到端的QoS，可为不同业务提供不同服务，实现了区分服务。
 
2.1	  3552 QACL特性
 S3552的ACL是基于VRP的ACL实现，主要目的是做到ACL和QOS分离并充分利用现有代码。所以，原来LanSwitch平台中的ACL和QOS混合的代码将不再在新产品中使用。
    VRP把ACL规则分为以下几类：
分类	再次分类	应用层次	软硬件使用情况
基于ACL号的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件。
基于ACL名的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件

基于数字创建的ACL，每种类型的ACL各自占领同一存储空间的某一段，各自使用各自的存储空间段，互不干涉，互不影响。该存储空间的使用情况是：
数字型的ACL的存储空间使用情况表：
基于数字的ACL	所使用的空间段
标准ACL	2000－2999
扩展ACL	3000－3999
二层ACL	4000－4999
注：
1. ACL子规则的硬件匹配顺序是：先下发的规则先生效，即有一条规则能构匹配的上则执行跳出，而不用再往后一一匹配其他的下发规则。3552的ACL子规则只支持在端口模式下下发，不支持全局下发子规则，如果希望多个端口执行此规则，必须在其他端口一一下发一遍，这是我个人一直认为不方便的地方。
2. ACL不支持的测试点有：vlan id只支持入端口，不支持出端口，所有配置ACL规则时入端口可含有vlan id,而出端口不能含有vlan id,否则不支持下发；
ACL规则不支持含有icmp code,icmp type参数，否则也不支持下发；
ACL规则含有tcp的source-port时，不支持gt,lt参数，只支持eq，range参数，如果选择range时，它的算法是：取值为2 n的整数倍
设初始值为56，则可算出当56为2 n的整数倍时，n可取值为0，1，2，3，所以有23=8个端口值，则终值为56＋8－1＝63，所以我们设置的range范围为（56，63），由此可知，这个范围大小并不是随便设的，必须按照此算法才能设置正确。

S3552 QoS特性在利用ACL进行流分类的基础上，提供了以下功能：
（1）支持DiffServ业务的区分和标记；
（2）支持TOS优先级的区分和标记；
（3）支持 802.1p 优先级的区分和标记；  
（4）支持优先级选择(priority)，可根据优先级映射到不同的队列 ；
（5）速率限制，可以控制端口或报文的转发速率；
（6）镜像(mirror), 拷贝整个包并发送给其他端口或CPU；
（7）策略转发（重定向），将包转发到任意输出端口或下一条IP地址； 
（8）队列调度管理，提供加权轮循调度，严格优先级等配置；
（9）拥塞管理，按照流分类规则排队，通过调度方法，设置每个队列的高低门限进行出对列。
（10）支持基于字节和包数目的统计功能 。
注：
1.	QOS的所有命令都在端口模式下下发，并不支持全局下发。
2.	速率限制：是对入端口进行速率限制，使得收到数据包的出端口速率得到限制。
如配置[3528-Ethernet0/2]traffic-limit in ip 3000 ？
INTEGER<8-1000000>  Committed Information Rate(Kbps)   
这个承诺平均速度是这样求来的：如果我希望的速率降为2k,则Committed Information Rate设为＝2×1000bps×64×8=1000kbps,如果入端口以100M发包，则出端口以2k的速率收包。
3.  镜像：将匹配规则的业务流复制到CPU或指定的输出端口，用于报文分析和监视，业务流还可以进一步区分为输入(ingress)或输出(egress)流，镜像时可以选择其一或者两种都选。
3552的monitor-port至多支持2个，一个是inbound，另一个是outbound；mirror-port至多支持outbound端口8个，inbound端口不受限制。
镜像端口与聚合端口的关系：monitor,mirror端口不能作为聚合端口，而聚合端口也不能再作为mirror,monitor端口。
4.  流模板：3552的新特性在于添加了流模板。在端口下发二层acl规则，则系统默认创建一个二层流模板，如果在端口下发三层acl规则，则系统默认创建一个三层流模板，或者可以手动创建一个用户自定义流模板，一般情况下只允许共存2个流模板，用户自定义流模板是一种混合流模板，可以设置任何参数，如果有二三层相关的参数，那么启动用户自定义流模板的端口才可以同时下发二三层acl规则，否则不能成功下发混合规则。

2.2  3526C QACL特性
     3526C的ACL分类比3552多了一种用户自定义的规则，用户自定义ACL根据用户的定义对二层数据帧的前64个字节中的任意字节进行匹配，对数据报文作出相应的处理。正确使用用户自定义访问控制列表需要用户对二层数据帧的构成有深入的了解。
3526C的ACL分类如下：
分类	再次分类	应用层次	软硬件使用情况
基于ACL号的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件
	用户自定义ACL		
基于ACL名的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件
	用户自定义ACL		

数字型的ACL的存储空间使用情况表：
基于数字的ACL	所使用的空间段
标准ACL	2000－2999
扩展ACL	3000－3999
二层ACL	4000－4999
用户自定义ACL	5000-5999

注：
1.	ACL子规则的硬件匹配顺序是：后下发的规则先生效，即对于每个流都得匹配所有下发的规则，虽然前面有一条能构匹配得上，但是还得往后匹配，也就是相当于从后往前匹配，后面得规格能匹配得上则执行跳出，支持在全局模式下下发packet-filter命令。有一种特殊情况是，标准ACL规则即单纯对于IP报文的源IP进行匹配的规则在初始化时已经创建了，为了system guard时过滤病毒源IP，所以如果先deny一个网段时，再下发permit一个主机ip时，实际上源IP的匹配总是在网段匹配之前，因此，网段匹配的规则起作用了，这个主机ip就永远不允许通过了，这是3526C的一个缺陷。
2.	3526C不支持含有fragment参数的规则，link规则中arp,cos同时设置的规则不支持下发。
3.	用于自定义ACL的设置：
如命令[3526C-acl-user-5000]rule 1 deny 000022 ffffff 0
设置了三个字节000022，mask是ffffff，两者相与得000022，从偏移量0开始匹配，必须三个字节都是000022；
如果命令是这样设置[3526C-acl-user-5000]rule 1 deny 001122 0000ff 0  
设置了三个字节001122，mask是0000ff，两者相与得000022，从偏移量0开始匹配，只要匹配得字节中第二个字节是22就可以满足规则了。

S3526C QoS特性在利用ACL进行流分类的基础上，提供了以下功能：
（1）支持DiffServ业务的区分和标记；
（2）支持TOS优先级的区分和标记；
（3）支持 802.1p 优先级的区分和标记；  
（4）支持优先级选择(priority)，可根据优先级映射到不同的队列 ；
（5）速率限制，可以控制端口或报文的转发速率；
（6）镜像(mirror), 拷贝整个包并发送给其他端口或CPU；
（7）策略转发，将包转发到任意输出端口或下一条IP地址； 
（8）队列调度管理，提供加权轮循调度、带最大时延的加权轮循调度等配置；
（9）支持基于字节和包数目的统计功能 。
注：
1.	 3526C的命令traffic-limit只能在端口模式下发，其他如traffic-redirect,traffic-priority,traffic-statistic都在全局模式下发，没有traffic-shape命令
2.	3526C没有端口镜像，只有流镜像，而且流镜像的监控端口只有一个，3552可以支持2个，当3526C的ACL规则中几条规则同时下发流镜像时，有一条规则的监控端口改变时，其他下发的规则也会自动改变。
3.	3526C没有拥塞管理的功能，只能达到端口限速，队列管理，流镜像，流重定向等功能。

2.3	 3050 QACL特性
3050的ACL分类情况类似于3526C，如图
分类	再次分类	应用层次	软硬件使用情况
基于ACL号的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件
	用户自定义ACL		
基于ACL名的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件
	用户自定义ACL		

数字型的ACL的存储空间使用情况表：
基于数字的ACL	所使用的空间段
标准ACL	2000－2999
扩展ACL	3000－3999
二层ACL	4000－4999
用户自定义ACL	5000-5999

注：
1.	ACL子规则的硬件匹配顺序是：后下发的规则先生效，每条流规则匹配所有下发的规则，最后一条能匹配的上的规则先生效。3050没有3526C存在的那个缺陷，匹配标准ACL规则时没有在初始化创建，所有先deny一个网段，再permit一个主机ip，这个主机ip可以通过，因为后下发的规则先生效。

3050的QOS也同3526C的QOS，利用ACL进行流分类的基础上，提供了以下功能：
（1）支持DiffServ业务的区分和标记；
（2）支持TOS优先级的区分和标记；
（3）支持 802.1p 优先级的区分和标记；  
（4）支持优先级选择(priority)，可根据优先级映射到不同的队列 ；
（5）速率限制，可以控制端口或报文的转发速率；
（6）镜像(mirror), 拷贝整个包并发送给其他端口或CPU；
（7）策略转发，将包转发到任意输出端口或下一条IP地址； 
（8）队列调度管理，提供加权轮循调度、带最大时延的加权轮循调度等配置；
（9）支持基于字节和包数目的统计功能 。
注：
1.	每个acl应用情况和qos的应用情况，功能和命令与3526C的一样，在此不再赘述了。
2.	3050的monitor端口也只有一个，但支持两种模式，即inbound,outbound;mirror端口至多支持3个，即inbound和outbound总共3个；3050不支持流镜像，没有流镜像命令。
镜像端口与聚合端口的关系：monitor端口不能作为聚合端口，mirror端口可以作为聚合端口，而聚合端口可以作为mirror端口，不能作为monitor端口。
3.	在端口下下发端口限速traffic-limit命令时，一般不能同时下发二层和三层的规则，而且当下发二层或三层规则时，这些规则的mask必须一致，否则下发不成功。
4.	3050还有一个特性是：rule可以复用使用，即同一条规则可以复用多个流动作，如果流规则已经下发满配置了，那么再换用其他动作使用同样的规则仍然可以下发。如packet-filter某些规则，虽然达到满配置了，但是别的流动作象traffic-redirect,traffic-statistic等还是可以下发packet-filter下发过的规则。
5.	3050的link规则中入端口包含端口号的话那就只能在此端口下下发traffic-limit命令，而不能在其他端口下发限速命令。
6.	3050的802.1p 优先级即cos与local-precedence有固定的关系，所以下发流时如traffic-priority不可以同时设置cos和local-precedence, local-precedence与queue的关系是：
local-precedence	queue
0,1	1
2,3	2
4,5	3
6,7	4

2.4  2050 QACL特性
    2050的acl特性比较简单，它是二层交换机，分类如下：
分类	再次分类	应用层次	软硬件使用情况
基于ACL号的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件。
基于ACL名的ACL	标准ACL	三层流规则	可以被各协议软件模块引用，也可以下发到硬件
	扩展ACL		
	二层ACL	二层流规则	只能下发到硬件

数字型的ACL的存储空间使用情况表：
基于数字的ACL	所使用的空间段
标准ACL	2000－2999
扩展ACL	3000－3999
二层ACL	4000－4999

注：
1.	2050的三层规则不支持下发，所以创建也没有意义，仅支持二层规则的下发，2050的link规则也只有deny动作，没有permit动作，命令比较简单，入端口也只有any，出端口也只有目的mac地址。
   2050的QOS更简单，只能实现几个基本的功能：
（1）支持DiffServ业务的区分和标记；
（2）支持 802.1p 优先级的区分和标记；  
（3）支持优先级选择(priority)，可根据优先级映射到不同的队列 ；
（4）速率限制，可以控制端口或报文的转发速率；
（5）镜像(mirror), 拷贝整个包并发送给其他端口或CPU；
（6）队列调度管理，提供加权轮循调度、带最大时延的加权轮循调度等配置；
（7）支持基于字节和包数目的统计功能 。
注：
1.	2050只支持端口镜像，不支持流镜像
2.	2050的cos和queue的关系是：
cos	queue
1,2	0
0,3	1
4,5	2
6,7	3
3.	2050的调度方法中wrr的比列是固定关系，见下表：


比值     queue	0	1	2	3
	2k	7k	28k	111k
	37k	111k		
	9k	28k	111k	
		37k	111k	
		9k	28k	111k
			37k	111k
		37k		111k
	37k			111k
	37k		111k	

3	问题说明
3.1  3552 QACL问题
	3552 的QACL问题多至出于流模板，尤其是与portal,port-isolate的组合测试，如下描述：
1.	3552流模板与portal,port-isolate的组合测试中容易导致端口满配置溢出，即超过满配置
2.	当端口达到满配置时，即一个百兆端口已经下发了256条规则，或一个千兆端口已经下发了512条规则，当此百兆或千兆端口所属的vlan启动port-isolate,或在接口下启动portal都可以成功的话，则会造成端口满配置溢出，超过满配置，因为启动port-isolate后，系统会在vlan中的每个端口默认下发两条规则，而启动portal，则在vlan中的端口默认下发三条规则，所以可以看出端口肯定会超额配置。
还有一种情况是：在vlan中先启动port-isolate后，在端口0/1只能下发规则254条规则，由于启动port-isolate的vlan2系统自动下发了两条规则，把0/1端口作为上行端口，则系统自动删除默认下发的两条规则，这时端口0/1又可以手动下发两条规则，端口0/1已经达到满配置了，然后再把0/1上行口删除，那么系统又自动添加两条规则，这中操作也会导致超过满配置。
	3552另一个重要测试点是规格测试，测试一个端口到底至多能下发多少条规则，一个设备至多能支撑下发多少规则，端口或设备达到满配置后是否有任何异常现象发生，以检测设备的稳定性。
1.	3552第一轮覆盖测试版本中曾出现过此问题：当时一个百兆端口只能下发一条规则，一个千端口也只能下发16条规则，而整个设备也达不到下发1024条规则的满配置。
2.	当此问题修改后，每个百兆端口可以下发规则达到256条，千兆端口可以下发512条规则的满配置，当已经达到设备的满配置1024条时，交换机仍然运行很正常，没有异常现象，当删除千兆端口上下发的规则时，有一个千兆口删除不成功，提示失败，这个也是满配置导致的错误现象吧。
	下面再举3552的一个例子，起初我抓图的方法是不正确的，在此引以为戒。
1.	目的是测试改变wrr权值大小，在端口上发包，另一端口收包，看是否按照新的权值比列出队列。
先看测试组网图：
                                                                                                                                                                

 
2.	在端口0/6设置wrr，希望队列1与队列2的出队列比值为1：1，在端口0/2发入队列1的单播报文，在端口0/4发入队列2的单播报文，而端口0/6抓包，我起初用capture在端口0/6抓图，这种方法是不正确的。
 
正确的方法是：trigger抓图，
先抓队列1的出队列比列，
 
再抓队列2的出队列比列，
 所以由图可知：队列1与队列2的出队列比值为4101：4102＝1：1
3.	然后再改变队列1与队列2的wrr权值为1：2，在端口0/6抓队列1的出队列图是：
 在端口0/6抓队列2的出队列比列图是：
 由图可知：队列1与队列2的出队列比值为：2733：5468＝1：2，所以改变wrr权值大小立刻生效了。
4.	测试wrr必须注意两点：
	抓包一定用trigger抓，而不用Capture
	构造包长不要过长，如果包很长的话，如包长1500byte,wrr比值尽量大些，如10：20，尽管和1：2结果一样，但是比值太小就测不出效果。

3.2  3526C QACL问题
     3526C的问题不是太多，有一个最严重的问题就是由芯片自动复位导致芯片不转发广播，单播报文。
1.	在发大流量下，在交换机上设置queue-scheduler后，3526C芯片就不转发报文了
2.	再反复测试，默认情况下，多个端口向一个目的端口发已知单播报文，这个目的端口就会发生堵死现象，则3526C系统会自动长生芯片复位，这时再改变queue-scheduler的值，则会出现芯片不转发现象。

3.3  3050 QACL问题
   3050的QACL功能也不是很强，毕竟是一个二层交换机，可以实现的简单功能基本上都没有问题，可以达到预期目标。一个易出现的问题可能还是规格测试。
1.	在3050设备上多创建一些规则，再使用流动作下发，下发后再删除再下发，这样多次的下发删除等反复操作可能产生问题，有时提示下发不成功是资源不足，可是设备中总共没有下发几条规则，资源肯定还是充足的。
2.	在一个端口限速下发多条规则，并不断改变规则的参数，先不删除规则的下发，下发能成功的话只会把以前的相同规则覆盖掉，如果反复同样的操作多的话可能又会导致改变某条规则的参数的操作不成功，并把此规则的前一个操作给删除了，并且以后再也不能下发此规则了，这个问题也会很严重地影响3050的性能。

3.4  2050 QACL问题
    2050的QACL实现上比较简单，象acl规则只有link规则可以下发，规则也比较简单化，qos只有在端口下发限速命令，限速命令只有8个取值范围；在全局模式下设置cos,priority来决定流入哪个队列，出队列的调度方法wrr比值不可以设置， 只有确定的关系，关系情况见上表。

3.5  问题总结
     QACL存在的问题主要取决于产品芯片的特性，许多是芯片的缺陷而导致QACL不能实现某些功能。以下几点是测试QACL的重点：
	注意acl规则的顺序问题，尤其是规则存在冲突时，看看规则是如何生效的。
	注意acl与time-range的结合，主要是绝对时间与周期时间的区别使用，看看在这两个时间段规则是否会生效。
	注重acl规则的规格测试，在每个端口达到满配置，或在设备上达到满配置，检测设备是否还正常运行，是否会影响其他的基本功能。
	注重产品相关QACL的新特性，把添加的新特性与其他模块相结合测试，或者两者的兼容上会有问题。

参考资料
1	《S3000系列以太网交换机操作手册》Chapter 5
2	“QOS技术白皮书”

